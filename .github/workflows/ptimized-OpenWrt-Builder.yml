# ç”±æ·±åº¦æ±‚ç´¢(DeepSeek)ä¼˜åŒ–çš„å·¥ä½œæµé…ç½® 
# ç‰ˆæœ¬ï¼šOpenWrt-Builder-2.1 
# é€‚é…æ—¥æœŸï¼š2025-02-11 
 
name: ğŸ› ï¸ OpenWrt Automated Builder 
 
on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘ 
  push:                 # ä»£ç æ¨é€è§¦å‘ 
    branches:
      - master 
    paths:
      - '**/config/**'
      - '**/diy-*.sh'
 
env:
  REPO_URL: "https://github.com/coolsnowwolf/lede" 
  REPO_BRANCH: "master"
  BUILD_THREADS: "${{ github.run_number  % 8 + 1 }}"  # åŠ¨æ€çº¿ç¨‹æ§åˆ¶ 
  CCACHE_DIR: "/builder/ccache"                      # ç¼“å­˜å¤ç”¨è·¯å¾„ 
  TZ: "Asia/Shanghai"
 
jobs:
  build:
    name: "ğŸ—ï¸ Build OpenWrt (Ubuntu 24.04)"
    runs-on: ubuntu-24.04 
    timeout-minutes: 180 
 
    steps:
    # ================= åˆå§‹åŒ–é˜¶æ®µ ================= 
    - name: "ğŸ” Checkout Code"
      uses: actions/checkout@v4 
      with:
        submodules: recursive 
 
    - name: "ğŸ’½ Storage Optimization"
      run: |
        # ç²¾ç¡®è®¡ç®—å¯ç”¨ç©ºé—´ï¼ˆGBå•ä½ï¼‰
        mnt_avail=$(df --output=avail -B1G /mnt | tail -1 | tr -d ' ')
        mnt_size=$((mnt_avail - 1))  # ä¿ç•™1GBç¼“å†² 
        
        root_avail=$(df --output=avail -B1G / | tail -1 | tr -d ' ')
        root_size=$((root_avail - 2))  # ä¿ç•™2GBç¼“å†² 
        
        # åˆ›å»ºè™šæ‹Ÿç£ç›˜ 
        sudo truncate -s "${mnt_size}G" /mnt/mnt.img  
        sudo truncate -s "${root_size}G" /root.img  
        
        # LVMåŠ¨æ€é…ç½® 
        sudo losetup /dev/loop6 /mnt/mnt.img  
        sudo losetup /dev/loop7 /root.img  
        sudo pvcreate /dev/loop[6-7]
        sudo vgcreate builder_vg /dev/loop[6-7]
        sudo lvcreate -l 100%FREE -n workspace builder_vg 
        sudo mkfs.xfs  /dev/builder_vg/workspace 
        sudo mkdir -p /builder 
        sudo mount /dev/builder_vg/workspace /builder 
        sudo chown -R runner:runner /builder 
 
    # ================= ç¯å¢ƒå‡†å¤‡é˜¶æ®µ ================= 
    - name: "âš™ï¸ Setup Environment"
      env:
        DEBIAN_FRONTEND: noninteractive 
      run: |
        # ç³»ç»ŸåŒ…ç®¡ç† 
        sudo apt-get -y purge azure* google* microsoft* phy* moby*  # ç§»é™¤æ— ç”¨ç»„ä»¶ 
        sudo apt-get -qq update 
        sudo apt-get -qq install \
          build-essential ccache cmake curl libncurses-dev \ 
          python3-dev rsync unzip zlib1g-dev git-lfs 
        
        # æ—¶åŒºé…ç½® 
        sudo timedatectl set-timezone "$TZ"
        
        # ç¼“å­˜ç³»ç»Ÿé…ç½® 
        sudo mkdir -p $CCACHE_DIR 
        sudo chown -R runner:runner $CCACHE_DIR 
        echo "max_size = 10.0G" | sudo tee $CCACHE_DIR/ccache.conf  
 
    # ================= ä»£ç æ„å»ºé˜¶æ®µ ================= 
    - name: "ğŸ“¥ Clone Repository"
      working-directory: /builder 
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt 
        ln -sf /builder/openwrt $GITHUB_WORKSPACE/openwrt 
 
    - name: "ğŸ”§ Custom Configuration"
      run: |
        # åº”ç”¨è‡ªå®šä¹‰é…ç½® 
        [ -e feeds.conf.default  ] && cp feeds.conf.default  openwrt/
        [ -e diy-part1.sh  ] && chmod +x diy-part1.sh  && ./diy-part1.sh  
        
        # åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ 
        cd openwrt 
        ./scripts/feeds update -a 
        ./scripts/feeds install -a 
        [ -e ../.config ] && cp ../.config .config 
        make defconfig 
 
    - name: "ğŸš€ Build Firmware"
      id: compile 
      run: |
        cd openwrt 
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV 
        
        # æ™ºèƒ½ç¼–è¯‘æ§åˆ¶ 
        if [ $BUILD_THREADS -gt 1 ]; then 
          make -j$BUILD_THREADS || make -j1 V=s 
        else 
          make -j1 V=s 
        fi 
 
        # æ„å»ºç»“æœéªŒè¯ 
        if [ -f bin/targets/*/*/openwrt-* ]; then 
          echo "status=success" >> $GITHUB_OUTPUT 
          echo "BUILD_STATUS=âœ… Success" >> $GITHUB_ENV 
        else 
          echo "status=failure" >> $GITHUB_OUTPUT 
          echo "BUILD_STATUS=âŒ Failed" >> $GITHUB_ENV 
          exit 1 
        fi 
 
    # ================= äº§ç‰©å¤„ç†é˜¶æ®µ ================= 
    - name: "ğŸ“¦ Package Artifacts"
      if: steps.compile.outputs.status  == 'success'
      run: |
        cd openwrt/bin/targets 
        TARGET_DIR=$(find . -maxdepth 2 -type d -name 'openwrt-*' | head -1)
        echo "FIRMWARE_PATH=$PWD/$TARGET_DIR" >> $GITHUB_ENV 
        
        # ç”Ÿæˆç‰ˆæœ¬æ ‡è¯† 
        echo "BUILD_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV 
        echo "BUILD_DATE=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV 
 
    - name: "ğŸ“¤ Upload to Artifacts"
      uses: actions/upload-artifact@v4 
      with:
        name: "firmware-${{ env.BUILD_HASH }}"
        path: ${{ env.FIRMWARE_PATH }}
 
    # ================= å‘å¸ƒé˜¶æ®µ ================= 
    - name: "ğŸš€ GitHub Release"
      uses: softprops/action-gh-release@v1 
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "build-${{ env.BUILD_DATE }}"
        name: "Build ${{ env.BUILD_HASH }}"
        body: |
          ### ğŸ› ï¸ Build Information 
          - Status: ${{ env.BUILD_STATUS }}
          - Commit: [${{ env.BUILD_HASH }}](https://github.com/${{  github.repository  }}/commit/${{ github.sha  }})
          - Timestamp: ${{ steps.date.outputs.timestamp  }}
        files: ${{ env.FIRMWARE_PATH }}/* 
 
    # ================= æ”¶å°¾é˜¶æ®µ ================= 
    - name: "ğŸ§¹ Cleanup"
      if: always()
      run: |
        sudo umount /builder 
        sudo vgremove -f builder_vg 
        sudo losetup -D 
        sudo rm -f /mnt/mnt.img  /root.img  
